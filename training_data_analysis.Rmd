---
title: "Training data analysis"
author: "Leah Kemp"
always_allow_html: true
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: false
    self_contained: yes
  editor_options: 
    chunk_output_type: console
---

```{r, setup, include = FALSE}
# global chunk settings
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.align = "center")
```

```{r, install_packages}
# install packages
utils::install.packages("googlesheets4")
utils::install.packages("tidyverse")
utils::install.packages("janitor")
utils::install.packages("DT")
utils::install.packages("scales")
utils::install.packages("lubridate")
utils::install.packages("plotly")
utils::install.packages("gtools")
```

```{r, load_packages}
# load packages
base::library(googlesheets4)
base::library(tidyverse)
base::library(janitor)
base::library(DT)
base::library(scales)
base::library(lubridate)
base::library(plotly)
base::library(gtools)
```

```{r, connect_sheets_api}
# utilise a github action to automatically render this rmd to html and render a github pages webpage
# this code chunk isn't required to run this code locally
# interactive access to the google sheets API can be triggered by running the first three lines of the next code chunk

# get the api key for accessing google sheets stored in the secrets section of the github repo
json <- base::Sys.getenv("SHEETS_API_JSON")

# utilise the google sheets api key to autorise access to the google sheets
googlesheets4::gs4_auth_configure(googlesheets4::gs4_auth(email = "leahmhkemp@gmail.com", path=json))
```

```{r, read_data}
# define ID's to google sheets
TP1 <- "10gONryFN9afkoZvwuJ18rZ_kEO2p_R-H2O85Nr8ktv4"
TP2 <- "1jSN7xN3CIQUQNUssWz2c9Wz-ab5qCaBYaYvdsNFKSY0"
TP3 <- "10_6J7E05NfRtssvikOKT3Fstxxl7lKAO1jbXFPL_DAw"

# read data from google sheets
TP1_GYM_CORE_FLEX <- googlesheets4::read_sheet(TP1, sheet = "GYM_CORE_FLEX")
TP1_POLE_CONDITIONING <- googlesheets4::read_sheet(TP1, sheet = "POLE_CONDITIONING")

TP2_M5_POLE_CONDITIONING <- googlesheets4::read_sheet(TP2, sheet = "M5_POLE_CONDITIONING")
TP2_M5_GYM_FULL_BODY <- googlesheets4::read_sheet(TP2, sheet = "M5_GYM_FULL_BODY")
TP2_M5_DAILY_FLEX <- googlesheets4::read_sheet(TP2, sheet = "M5_DAILY_FLEX")
TP2_M4_POLE_CONDITIONING <- read_sheet(TP2, sheet = "M4_POLE_CONDITIONING")
TP2_M4_DAILY_FLEX <- googlesheets4::read_sheet(TP2, sheet = "M4_DAILY_FLEX")
TP2_M4_POLE_OPEN_TRAIN <- googlesheets4::read_sheet(TP2, sheet = "M4_POLE_OPEN_TRAIN")
TP2_M4_GYM_FULL_BODY <- googlesheets4::read_sheet(TP2, sheet = "M4_GYM_FULL_BODY")
TP2_M3_DAILY_FLEX <- googlesheets4::read_sheet(TP2, sheet = "M3_DAILY_FLEX")
TP2_M3_POLE_UPPER_BODY_CORE <- googlesheets4::read_sheet(TP2, sheet = "M3_POLE_UPPER_BODY_CORE")
TP2_M3_GYM_FULL_BODY <- googlesheets4::read_sheet(TP2, sheet = "M3_GYM_FULL_BODY")
TP2_M2_FULL_BODY <- googlesheets4::read_sheet(TP2, sheet = "M2_FULL_BODY")
TP2_M2_CORE_FLEX <- googlesheets4::read_sheet(TP2, sheet = "M2_CORE_FLEX")
TP2_M1_POLE <- googlesheets4::read_sheet(TP2, sheet = "M1_POLE")
TP2_M1_GYM <- googlesheets4::read_sheet(TP2, sheet = "M1_GYM")

TP3_M2_GYM_FULL_BODY <- googlesheets4::read_sheet(TP3, sheet = "M2_GYM_FULL_BODY")
TP3_M1_GYM_FULL_BODY <- googlesheets4::read_sheet(TP3, sheet = "M1_GYM_FULL_BODY")
TP3_M2_POLE_CONDITIONING <- googlesheets4::read_sheet(TP3, sheet = "M2_POLE_CONDITIONING")
TP3_M3_GYM_FULL_BODY <- googlesheets4::read_sheet(TP3, sheet = "M3_GYM_FULL_BODY")
TP3_M3_POLE_CONDITIONING <- googlesheets4::read_sheet(TP3, sheet = "M3_POLE_CONDITIONING")
TP3_M4_GYM_FULL_BODY <- googlesheets4::read_sheet(TP3, sheet = "M4_GYM_FULL_BODY")
TP3_M4_POLE_CONDITIONING <- googlesheets4::read_sheet(TP3, sheet = "M4_POLE_CONDITIONING")
```

```{r, define_functions}
# setup function to prepare the weights data
prepare_weights_data <- function(df_list) {
  
  data <- df_list %>%
    
    # remove empty rows
    janitor::remove_empty(c("rows")) %>%  
    
    # remove some columns to only get the weights data
    # this will also remove columns that don't have a date in the name (data hasn't been entered in those columns)
    dplyr::select(session,
                  requirement,
                  exercise,
                  matches("\\d{1,2}/\\d{1,2}/\\d{1,4}")) %>%
    dplyr::select(!dplyr::contains(c("notes", "reps_or_secs"))) %>%
    
    # format all columns that have a date in their name, to integer format
    dplyr::mutate_at(dplyr::vars(dplyr::matches("\\d{1,2}/\\d{1,2}/\\d{1,4}.set")), base::as.double) %>%
    
    # make this data long for downstream analyses
    # this also extracts the date from the column names and makes a variable out of it
    tidyr::pivot_longer(cols = -c(session, requirement, exercise),
                        names_pattern = "(\\d{1,2}/\\d{1,2}/\\d{1,4}).(....).(weight)$",
                        names_to = c("date", "set", "weight")) %>%
    dplyr::mutate(date=base::ifelse(date=="", "value", date)) %>%
    
    # clean up columns
    dplyr::select(-weight) %>%
    dplyr::rename(weight = value) %>%
    
    # remove rows with NA values (exercise not done)
    stats::na.omit()
  
  # format date column as a date
  data$date <- base::as.Date(data$date,"%d/%m/%y", tz = "NZ")
  
  return(data)
  
}

# setup function to prepare the reps/secs data
prepare_reps_or_secs_data <- function(df_list) {
  
  data <- df_list %>%
    
    # remove empty rows
    janitor::remove_empty(c("rows")) %>%  
    
    # remove some columns to only get the sets and reps
    # this will also remove columns that don't have a date in the name (data hasn't been entered in those columns)
    dplyr::select(session,
                  requirement,
                  exercise,
                  dplyr::matches("\\d{1,2}/\\d{1,2}/\\d{1,4}")) %>%
    # remove some columns to only get the sets and reps
    select(!contains(c("notes", "weight"))) %>%
    
    # format all columns that have a date in their name, to integer format
    dplyr::mutate_at(dplyr::vars(dplyr::matches("\\d{1,2}/\\d{1,2}/\\d{1,4}.set")), base::as.integer) %>%
    
    # make this data long for downstream analyses
    # this also extracts the date from the column names and makes a variable out of it
    tidyr::pivot_longer(cols = -c(session, requirement, exercise),
                        names_pattern = "(\\d{1,2}/\\d{1,2}/\\d{1,4}).(....).(reps_or_secs)$",
                        names_to = c("date", "set", "reps_or_secs")) %>%
    dplyr::mutate(date=base::ifelse(date=="", "value", date)) %>%
    
    # clean up columns
    dplyr::select(-reps_or_secs) %>%
    dplyr::rename(reps_or_secs = value) %>%
    
    # remove rows with NA values (exercise not done)
    stats::na.omit()
  
  # format date column as a date
  data$date <- base::as.Date(data$date,"%d/%m/%y", tz = "NZ")
  
  return(data)
  
}

# setup function to grab pr from a list of dataframes split by exercise
get_pr <- function(data_list) {
  
  # order data by highest weight and highest number of reps/secs (priority to highest weight)
  ordered <- data_list %>%
    dplyr::arrange(dplyr::desc(weight), dplyr::desc(reps_or_secs))
  
  # get the unique values (remove repeated reps x weight combinations)
  ordered <- unique(ordered)
  
  # get the top row
  pr <- ordered[1, ]
  
  return(pr)
  
}
```

```{r, prepare_data}
# create a list of the datasets I'm working with
dataset_list <- base::list(TP1_POLE_CONDITIONING,
                           TP1_GYM_CORE_FLEX,
                           TP2_M5_POLE_CONDITIONING,
                           TP2_M5_GYM_FULL_BODY,
                           TP2_M5_DAILY_FLEX,
                           TP2_M4_POLE_CONDITIONING,
                           TP2_M4_DAILY_FLEX,
                           TP2_M4_POLE_OPEN_TRAIN,
                           TP2_M4_GYM_FULL_BODY,
                           TP2_M3_DAILY_FLEX,
                           TP2_M3_POLE_UPPER_BODY_CORE,
                           TP2_M3_GYM_FULL_BODY,
                           TP2_M2_FULL_BODY,
                           TP2_M2_CORE_FLEX,
                           TP2_M1_POLE,
                           TP2_M1_GYM,
                           TP3_M2_GYM_FULL_BODY,
                           TP3_M1_GYM_FULL_BODY,
                           TP3_M2_POLE_CONDITIONING,
                           TP3_M3_GYM_FULL_BODY,
                           TP3_M3_POLE_CONDITIONING,
                           TP3_M4_GYM_FULL_BODY,
                           TP3_M4_POLE_CONDITIONING)

# prepare weights and reps/secs data
weights_data <- base::lapply(dataset_list, prepare_weights_data)
reps_or_secs_data <- base::lapply(dataset_list, prepare_reps_or_secs_data)

# collapse dataframes into one dataset
weights_data <- base::Reduce(base::rbind, weights_data)
reps_or_secs_data <- base::Reduce(base::rbind, reps_or_secs_data)

# merge weights and reps/secs data
data <- dplyr::full_join(weights_data,
                         reps_or_secs_data,
                         by = c("session", "requirement", "exercise", "date", "set"))

# replace missing values for weight (where I didn't enter a value since no weight was used) with 0
data <- base::replace(data, base::is.na(data), 0)

# setup lists to generalise the requirement list
upper_body_strength <- c("Cup grip handspring deadlift",
                         "Internal and external shoulder rotation",
                         "No leg climb",
                         "Pushing strength",
                         "Shoulder flexion (with external rotation)",
                         "Shoulder flexion (with neutral)",
                         "Shoulder mount deadlift",
                         "True grip ayesha",
                         "Twisted grip handspring deadlift",
                         "Upper body power",
                         "Upper body strength",
                         "Pulling strength")

lower_body_strength <- c("Lower body power",
                         "Lower body strength")

core_strength <- c("Anti-extension core strength",
                   "Anti-lateral core strength",
                   "Anti-rotation core strength")

full_body_strength <- c("Full body strength")

upper_body_flexibility <- c("Back flexibility",
                            "Thoracic rotation",
                            "Thoracic lateral bend",
                            "Upper back/shoulder flexibility",
                            "Shoulder flexion flexibility and strength")

lower_body_flexibility <- c("Active hamstring flexibility",
                            "Active hamstring flexibility/hip flexion strength",
                            "Active hip adduction and abduction",
                            "Front splits",
                            "Hamstring nerve tension",
                            "Hip extension flexibility",
                            "Internal and external hip rotation",
                            "Middle split",
                            "Pancake split",
                            "Foot point",
                            "Microbend drills",
                            "Hip flexor flexibility",
                            "Hamstring flexibility",
                            "Hip flexion strength",
                            "Glute and hamstring strength",
                            "Hip abduction strength",
                            "Hip adduction strength",
                            "Hamstring flexibility")

skills <- c("Shouldermount",
            "Shouldermount flag",
            "Shouldermount deadlift",
            "Shouldermount hops up pole",
            "Muscle up to pencil",
            "Human flag",
            "Spatchcock",
            "Twisted grip handspring deadlift",
            "Twisted grip aerial handspring",
            "Twisted grip iron X",
            "Bird of paradise",
            "No leg climb",
            "Twisted grip muscle up to pencil",
            "Invert",
            "Aerial invert",
            "Aerial twisted grip deadlift",
            "Aerial true grip muscle up",
            "Grip strength")

# add this broader requirements as a new column in my data
data <- data %>%
  dplyr::mutate(requirement_broad = dplyr::case_when(requirement %in% upper_body_strength ~ "Upper body strength",
                                                     requirement %in% lower_body_strength ~ "Lower body strength",
                                                     requirement %in% core_strength ~ "Core strength",
                                                     requirement %in% full_body_strength ~ "Full body strength",
                                                     requirement %in% upper_body_flexibility  ~ "Upper body flexibility",
                                                     requirement %in% lower_body_flexibility ~ "Lower body flexibility",
                                                     requirement %in% skills ~ "Skills"))

# get a smaller set of the data that excludes flexibility training
data_no_flex <- data %>%
  dplyr::filter(!requirement_broad %in% c("Lower body flexibility", "Upper body flexibility"))
  
# get the combinations of weights and reps/sec for each exercise
weight_reps_pairs <- data_no_flex %>%
  dplyr::select(-c(set, requirement, requirement_broad)) %>%
  dplyr::group_by(exercise,reps_or_secs, weight) %>%
  dplyr::summarise(reps_or_secs, weight)

# split dataset by exercise
weight_reps_pairs_by_exercise <- base::split(weight_reps_pairs, weight_reps_pairs$exercise)
```

## PR

PR's for all pole and gym exercises (excludes flexibility data)

```{r, pr, out.width = "100%"}
# calculate PR for each exercise
pr <- base::lapply(weight_reps_pairs_by_exercise, get_pr)

# collapse results into a single dataframe
pr <- base::Reduce(rbind, pr)

# create a column with both reps and weight - pretty format for tables
pr <- pr %>%
  dplyr::mutate(pr_pretty = paste0(reps_or_secs, " x ", weight, " kgs")) %>%
  as.data.frame()

# get the first and the most recent date the pr was achieved
tmp <- dplyr::right_join(data, pr)

pr <- tmp %>% group_by(exercise, pr_pretty) %>%
  summarise(first_date = min(date),
            most_recent_date = max(date))

# put in table
pr %>%
  DT::datatable(filter = "top",
                colnames = c("Exercise",
                             "PR (reps/secs x weight)",
                             "First date",
                             "Most recent date"),
                rownames = FALSE,
                options = list(dom = "Blfrtip",
                               bFilter = FALSE,
                               lengthMenu = list(c(10, 50, -1), 
                                                 c("10", "50", "All")),
                               paging = TRUE))
```

## PR's last week!

```{r, recent_pr, out.width = "100%"}
# get current date
cur_date <- Sys.Date()

# calculate recent PR's
pr %>%
  filter(between(first_date, cur_date-7, cur_date)) %>%
  dplyr::select(exercise, pr_pretty) %>%
  DT::datatable(filter = "top",
                colnames = c("Exercise",
                             "PR (reps/secs x weight)"),
                rownames = FALSE,
                options = list(dom = "Blfrtip",
                               bFilter = FALSE,
                               lengthMenu = list(c(10, 50, -1), 
                                                 c("10", "50", "All")),
                               paging = TRUE))
```

## The big 3 {.tabset .tabset-fade}

A closer look at the big 3 - bench, squat, deadlift

```{r, big_3}
# extract data for the big three - bench, squat, deadlift
bench <- data %>% dplyr::filter(exercise == "Barbell chest press (flat)")
deadlift <- data %>% dplyr::filter(exercise == "Barbell deadlift (conventional)")
squat <- data %>% dplyr::filter(exercise == "Barbell squat")
```

### Bench

```{r, bench, out.width = "100%"}
# generate table for bench
plotly::plot_ly(bench) %>%
  add_trace(x = ~date,
            y = ~weight,
            size = ~reps_or_secs,
            type = "scatter",
            mode = "markers",
            hoverinfo = "text",
            text = ~paste(date, "<br>", reps_or_secs, " x ", weight, "kgs")) %>%
  layout(yaxis = list(title = "Weight (kg's)"),
         xaxis = list(title = "Date"))
```

### Deadlift

```{r, deadlift, out.width = "100%"}
# generate table for deadlift
plotly::plot_ly(deadlift) %>%
  add_trace(x = ~date,
            y = ~weight,
            size = ~reps_or_secs,
            type = "scatter",
            mode = "markers",
            hoverinfo = "text",
            text = ~paste(date, "<br>", reps_or_secs, " x ", weight, "kgs")) %>%
  layout(yaxis = list(title = "Weight (kg's)"),
         xaxis = list(title = "Date"))
```

### Squat

```{r, squat, out.width = "100%"}
# generate table for squat
plotly::plot_ly(squat) %>%
  add_trace(x = ~date,
            y = ~weight,
            size = ~reps_or_secs,
            type = "scatter",
            mode = "markers",
            hoverinfo = "text",
            text = ~paste(date, "<br>", reps_or_secs, " x ", weight, "kgs")) %>%
  layout(yaxis = list(title = "Weight (kg's)"),
         xaxis = list(title = "Date"))
```
